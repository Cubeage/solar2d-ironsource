name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download IronSource iOS SDK 9.3.0
        run: |
          curl -L "https://raw.githubusercontent.com/ironsource-mobile/iOS-sdk/master/9.3.0/IronSource9.3.0.zip" \
               -o IronSource9.3.0.zip
          mkdir -p ironsource_sdk
          unzip -q IronSource9.3.0.zip -d ironsource_sdk

          XCFW=$(find ironsource_sdk -type d -name "IronSource.xcframework" | head -1)
          echo "XCFramework: $XCFW"

          # Find arm64 device slice (exclude simulator slices)
          ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" \
                     -path "*/ios-arm64/*" ! -path "*simulator*" | head -1)
          if [ -z "$ARM64_FW" ]; then
            ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" \
                       ! -path "*simulator*" | head -1)
          fi
          echo "arm64 framework: $ARM64_FW"
          ARM64_DIR=$(dirname "$ARM64_FW")

          echo "IRONSOURCE_ARM64_DIR=$GITHUB_WORKSPACE/$ARM64_DIR" >> "$GITHUB_ENV"
          echo "IRONSOURCE_ARM64_FW=$GITHUB_WORKSPACE/$ARM64_FW"   >> "$GITHUB_ENV"

          echo "SDK structure:"; find ironsource_sdk -maxdepth 5 | head -30

      - name: Compile iOS static library
        run: |
          CORONA_INCLUDE="$GITHUB_WORKSPACE/ios/corona_sdk"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "IRONSOURCE_ARM64_DIR = $IRONSOURCE_ARM64_DIR"
          echo "CORONA_INCLUDE       = $CORONA_INCLUDE"
          ls "$CORONA_INCLUDE"

          cd ios
          # v9.3.4: Import IronSource headers for method signatures only (no class refs).
          # CLASS-level calls use objc_getClass()+objc_msgSend; INSTANCE calls are direct.
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=13.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$IRONSOURCE_ARM64_DIR" \
            -DNDEBUG -Os \
            -Wno-nullability-completeness \
            -Wno-arc-performSelector-leaks \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o

          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          ls -lh libplugin_ironSource.a
          echo "iOS static library built successfully"

      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone

          # Static library + metadata
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua              package_iphone/metadata.lua

          # Include IronSource.framework (arm64 device slice, flat .framework)
          # at ROOT of iphone.tgz so CoronaBuilder can:
          #   1. Find it via -F".../plugin.ironSource" framework search path
          #   2. Link it via -framework IronSource (declared in metadata.lua)
          #   3. Embed it in the final IPA's Frameworks/ directory
          if [ -n "$IRONSOURCE_ARM64_FW" ] && [ -d "$IRONSOURCE_ARM64_FW" ]; then
            cp -r "$IRONSOURCE_ARM64_FW" package_iphone/IronSource.framework
            echo "Included IronSource.framework (arm64 device slice)"
            ls -la package_iphone/IronSource.framework/
          else
            echo "ERROR: IronSource.framework not found!" && exit 1
          fi

          cd package_iphone
          tar czf ../iphone.tgz .
          echo "iphone.tgz contents:"
          tar tzf ../iphone.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
