name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Get Corona iOS SDK headers from CoronaCards-iOS zip
      # -----------------------------------------------------------------------
      - name: Fetch Corona iOS headers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get CoronaCards-iOS (not MetalANGLE variant) â€” much smaller than DMG
          ASSET_URL=$(gh api repos/coronalabs/corona/releases/latest \
            --jq '[.assets[] | select((.name | startswith("CoronaCards-iOS-")) and (.name | endswith(".zip")) and (.name | contains("MetalANGLE") | not))][0] | .browser_download_url')
          echo "Downloading CoronaCards-iOS: $ASSET_URL"
          curl -L "$ASSET_URL" -o CoronaCards-iOS.zip
          unzip -o CoronaCards-iOS.zip -d coronacards_ios
          echo "CoronaCards-iOS contents:"
          find coronacards_ios -maxdepth 3 | head -30
          
          mkdir -p corona_ios_sdk/include
          HEADER=$(find coronacards_ios -name "CoronaLua.h" | head -1)
          if [ -n "$HEADER" ]; then
            HEADER_DIR=$(dirname "$HEADER")
            cp "$HEADER_DIR"/*.h corona_ios_sdk/include/ 2>/dev/null || true
            echo "Copied headers from: $HEADER_DIR"
            ls corona_ios_sdk/include/
          else
            echo "CoronaLua.h not in CoronaCards-iOS zip, falling back to DMG..."
            DMG_URL=$(gh api repos/coronalabs/corona/releases/latest \
              --jq '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
            echo "Downloading DMG: $DMG_URL"
            curl -L "$DMG_URL" -o Solar2D.dmg
            hdiutil attach Solar2D.dmg -mountpoint /Volumes/Solar2D -nobrowse -quiet
            HEADER=$(find /Volumes/Solar2D -name "CoronaLua.h" 2>/dev/null | head -1)
            if [ -n "$HEADER" ]; then
              HEADER_DIR=$(dirname "$HEADER")
              cp "$HEADER_DIR"/*.h corona_ios_sdk/include/
              echo "Copied headers from DMG: $HEADER_DIR"
              ls corona_ios_sdk/include/
            else
              echo "ERROR: CoronaLua.h not found"
              exit 1
            fi
            hdiutil detach /Volumes/Solar2D -quiet
          fi

      # -----------------------------------------------------------------------
      # 2. Install IronSource iOS SDK via CocoaPods
      # -----------------------------------------------------------------------
      - name: Install IronSource iOS SDK via CocoaPods
        run: |
          mkdir -p /tmp/ironsource_pod/App.xcodeproj
          
          cat > /tmp/ironsource_pod/Podfile << 'PODFILE'
platform :ios, '12.0'
use_frameworks!
target 'App' do
  pod 'IronSourceSDK', '~> 9.2'
end
PODFILE

          # Minimal dummy .xcodeproj
          mkdir -p /tmp/ironsource_pod/App.xcodeproj
          cat > /tmp/ironsource_pod/App.xcodeproj/project.pbxproj << 'PBXEOF'
// !$*UTF8*$!
{
  archiveVersion = 1;
  classes = {};
  objectVersion = 56;
  objects = {
    A1 = {isa = PBXProject; buildConfigurationList = A2; compatibilityVersion = "Xcode 14.0"; mainGroup = A3; targets = (A4); };
    A2 = {isa = XCConfigurationList; buildConfigurations = (A5, A6); defaultConfigurationName = Release; };
    A3 = {isa = PBXGroup; children = (); sourceTree = "<group>"; };
    A4 = {isa = PBXNativeTarget; buildConfigurationList = A7; buildPhases = (); name = App; productType = "com.apple.product-type.application"; };
    A5 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos; TARGETED_DEVICE_FAMILY = "1,2";}; name = Debug; };
    A6 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos; TARGETED_DEVICE_FAMILY = "1,2";}; name = Release; };
    A7 = {isa = XCConfigurationList; buildConfigurations = (A5, A6); defaultConfigurationName = Release; };
  };
  rootObject = A1;
}
PBXEOF

          cd /tmp/ironsource_pod
          pod install --repo-update 2>&1 | tail -20 || true
          
          echo "Searching for IronSource framework..."
          find /tmp/ironsource_pod -name "IronSource*" 2>/dev/null | head -10
          
          # Also check CocoaPods cache
          find ~/Library/Caches/CocoaPods -name "IronSource*" 2>/dev/null | head -5 || true
          
          XCFW=$(find /tmp/ironsource_pod -name "IronSource.xcframework" 2>/dev/null | head -1)
          FW=$(find /tmp/ironsource_pod -name "IronSource.framework" 2>/dev/null | head -1)
          # Also check in Pods directory
          XCFW2=$(find /tmp/ironsource_pod/Pods -name "IronSource.xcframework" 2>/dev/null | head -1)
          FW2=$(find /tmp/ironsource_pod/Pods -name "IronSource.framework" 2>/dev/null | head -1)
          FRAMEWORK="${XCFW:-$XCFW2}"
          FRAMEWORK="${FRAMEWORK:-$FW}"
          FRAMEWORK="${FRAMEWORK:-$FW2}"
          
          if [ -n "$FRAMEWORK" ]; then
            mkdir -p "$GITHUB_WORKSPACE/ironsource_framework"
            cp -r "$FRAMEWORK" "$GITHUB_WORKSPACE/ironsource_framework/"
            echo "IronSource framework: $FRAMEWORK"
            echo "IRONSOURCE_FW=$GITHUB_WORKSPACE/ironsource_framework/$(basename $FRAMEWORK)" >> $GITHUB_ENV
          else
            echo "ERROR: IronSource framework not found"
            ls -la /tmp/ironsource_pod/ || true
            ls -la /tmp/ironsource_pod/Pods/ 2>/dev/null || true
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 3. Compile the plugin
      # -----------------------------------------------------------------------
      - name: Compile iOS static library
        run: |
          FRAMEWORK_DIR=$(dirname "$IRONSOURCE_FW")
          CORONA_INCLUDE="$GITHUB_WORKSPACE/corona_ios_sdk/include"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "Framework: $IRONSOURCE_FW"
          echo "Framework dir: $FRAMEWORK_DIR"
          echo "Corona include: $CORONA_INCLUDE"
          ls "$CORONA_INCLUDE" 2>/dev/null || echo "WARNING: No Corona headers"

          cd ios
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=12.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$FRAMEWORK_DIR" \
            -DNDEBUG -Os \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o

          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          echo "Built: libplugin_ironSource.a"
          ls -lh libplugin_ironSource.a

      # -----------------------------------------------------------------------
      # 4. Package iphone.tgz
      # -----------------------------------------------------------------------
      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone/Frameworks
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua package_iphone/metadata.lua

          if [ -n "$IRONSOURCE_FW" ] && [ -e "$IRONSOURCE_FW" ]; then
            FNAME=$(basename "$IRONSOURCE_FW")
            cp -r "$IRONSOURCE_FW" "package_iphone/Frameworks/$FNAME"
            echo "Included: $FNAME"
          fi

          cd package_iphone
          tar czf ../iphone.tgz .
          echo "iphone.tgz contents:"
          tar tzf ../iphone.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
