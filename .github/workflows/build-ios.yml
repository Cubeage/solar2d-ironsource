name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download IronSource iOS SDK 9.3.0
        run: |
          # Direct download from ironsource-mobile/iOS-sdk GitHub repo
          curl -L "https://raw.githubusercontent.com/ironsource-mobile/iOS-sdk/master/9.3.0/IronSource9.3.0.zip" \
               -o IronSource9.3.0.zip
          mkdir -p ironsource_sdk
          unzip -q IronSource9.3.0.zip -d ironsource_sdk

          # Find the xcframework
          XCFW=$(find ironsource_sdk -type d -name "IronSource.xcframework" | head -1)
          echo "XCFramework: $XCFW"

          # Find arm64 device slice (exclude simulator)
          ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" \
                     -path "*/ios-arm64/*" ! -path "*simulator*" | head -1)
          if [ -z "$ARM64_FW" ]; then
            ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" | grep -v simulator | head -1)
          fi
          ARM64_DIR=$(dirname "$ARM64_FW")
          echo "arm64 framework: $ARM64_FW"
          echo "arm64 dir: $ARM64_DIR"

          # Store absolute paths (compile step does 'cd ios' so relative paths break)
          echo "IRONSOURCE_XCFW=$GITHUB_WORKSPACE/$XCFW"          >> "$GITHUB_ENV"
          echo "IRONSOURCE_ARM64_DIR=$GITHUB_WORKSPACE/$ARM64_DIR" >> "$GITHUB_ENV"

          echo "SDK structure:"; find ironsource_sdk -maxdepth 4 | head -20

      - name: Compile iOS static library
        run: |
          # Corona SDK headers are committed in ios/corona_sdk/ (sourced from coronalabs/corona repo)
          CORONA_INCLUDE="$GITHUB_WORKSPACE/ios/corona_sdk"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "IRONSOURCE_ARM64_DIR = $IRONSOURCE_ARM64_DIR"
          echo "CORONA_INCLUDE = $CORONA_INCLUDE"
          ls "$CORONA_INCLUDE"

          cd ios
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=12.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$IRONSOURCE_ARM64_DIR" \
            -DNDEBUG -Os \
            -Wno-nullability-completeness \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o

          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          ls -lh libplugin_ironSource.a
          echo "iOS static library built successfully"

      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone/Frameworks

          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua package_iphone/metadata.lua

          # Include the full xcframework so the app can link against it
          if [ -n "$IRONSOURCE_XCFW" ] && [ -e "$IRONSOURCE_XCFW" ]; then
            cp -r "$IRONSOURCE_XCFW" package_iphone/Frameworks/
            echo "Included: $(basename $IRONSOURCE_XCFW)"
          fi

          cd package_iphone
          tar czf ../iphone.tgz .
          echo "iphone.tgz contents:"; tar tzf ../iphone.tgz | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
