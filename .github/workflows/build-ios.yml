name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Get Corona iOS SDK headers from CoronaCards-iOS zip
      #    (lighter than 280MB DMG; same headers)
      # -----------------------------------------------------------------------
      - name: Fetch Corona iOS headers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try CoronaCards-iOS first (much smaller than DMG)
          ASSET_URL=$(gh api repos/coronalabs/corona/releases/latest \
            --jq '.assets[] | select(.name | startswith("CoronaCards-iOS-") and (.name | endswith(".zip")) and (.name | contains("MetalANGLE") | not)) | .browser_download_url')
          echo "Downloading CoronaCards-iOS: $ASSET_URL"
          curl -L "$ASSET_URL" -o CoronaCards-iOS.zip
          unzip -o CoronaCards-iOS.zip -d coronacards_ios
          
          mkdir -p corona_ios_sdk/include
          # Search for Corona headers
          find coronacards_ios -name "CoronaLua.h" | head -5
          HEADER=$(find coronacards_ios -name "CoronaLua.h" | head -1)
          if [ -n "$HEADER" ]; then
            HEADER_DIR=$(dirname "$HEADER")
            cp "$HEADER_DIR"/*.h corona_ios_sdk/include/ 2>/dev/null || true
            echo "Copied headers from: $HEADER_DIR"
            ls corona_ios_sdk/include/
          else
            # Fallback: fetch from Solar2D DMG
            DMG_URL=$(gh api repos/coronalabs/corona/releases/latest \
              --jq '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
            echo "Falling back to DMG: $DMG_URL"
            curl -L "$DMG_URL" -o Solar2D.dmg
            hdiutil attach Solar2D.dmg -mountpoint /Volumes/Solar2D -nobrowse -quiet
            HEADER=$(find /Volumes/Solar2D -name "CoronaLua.h" 2>/dev/null | head -1)
            if [ -n "$HEADER" ]; then
              HEADER_DIR=$(dirname "$HEADER")
              cp "$HEADER_DIR"/*.h corona_ios_sdk/include/
              echo "Copied headers from DMG: $HEADER_DIR"
            fi
            hdiutil detach /Volumes/Solar2D -quiet
          fi
          ls -la corona_ios_sdk/include/ || echo "WARNING: No Corona headers found"

      # -----------------------------------------------------------------------
      # 2. Install IronSource iOS SDK via CocoaPods
      # -----------------------------------------------------------------------
      - name: Install IronSource iOS SDK via CocoaPods
        run: |
          # Create a minimal Podfile to pull IronSource SDK
          mkdir -p /tmp/ironsource_pod
          cat > /tmp/ironsource_pod/Podfile << 'PODFILE'
          platform :ios, '12.0'
          use_frameworks!
          target 'App' do
            pod 'IronSourceSDK', '~> 9.2'
          end
          PODFILE
          
          # Create a dummy project for pod install
          mkdir -p /tmp/ironsource_pod/App.xcodeproj
          cat > /tmp/ironsource_pod/App.xcodeproj/project.pbxproj << 'PBXEOF'
          // !$*UTF8*$!
          {
            archiveVersion = 1;
            classes = {};
            objectVersion = 56;
            objects = {
              AB1 = {isa = PBXProject; buildConfigurationList = AB2; compatibilityVersion = "Xcode 14.0"; mainGroup = AB3; targets = (AB4); };
              AB2 = {isa = XCConfigurationList; buildConfigurations = (AB5,AB6); defaultConfigurationName = Release; };
              AB3 = {isa = PBXGroup; children = (); };
              AB4 = {isa = PBXNativeTarget; buildConfigurationList = AB7; buildPhases = (); name = App; productType = "com.apple.product-type.application"; };
              AB5 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos; TARGETED_DEVICE_FAMILY = "1,2";}; name = Debug; };
              AB6 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos; TARGETED_DEVICE_FAMILY = "1,2";}; name = Release; };
              AB7 = {isa = XCConfigurationList; buildConfigurations = (AB5,AB6); defaultConfigurationName = Release; };
            };
            rootObject = AB1;
          }
          PBXEOF
          
          cd /tmp/ironsource_pod
          pod install --repo-update 2>&1 | tail -30 || true
          
          echo "Searching for IronSource framework..."
          find /tmp/ironsource_pod -name "IronSource*" 2>/dev/null | head -10
          
          # Copy framework to workspace
          XCFW=$(find /tmp/ironsource_pod -name "IronSource.xcframework" 2>/dev/null | head -1)
          FW=$(find /tmp/ironsource_pod -name "IronSource.framework" 2>/dev/null | head -1)
          FRAMEWORK="${XCFW:-$FW}"
          
          if [ -n "$FRAMEWORK" ]; then
            mkdir -p "$GITHUB_WORKSPACE/ironsource_framework"
            cp -r "$FRAMEWORK" "$GITHUB_WORKSPACE/ironsource_framework/"
            echo "IronSource framework: $FRAMEWORK"
          else
            echo "ERROR: IronSource framework not found via CocoaPods"
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 3. Compile the plugin
      # -----------------------------------------------------------------------
      - name: Compile iOS static library
        run: |
          IRONSOURCE_XCFW=$(find ironsource_framework -name "IronSource.xcframework" 2>/dev/null | head -1)
          IRONSOURCE_FW=$(find ironsource_framework -name "IronSource.framework" 2>/dev/null | head -1)
          FRAMEWORK="${IRONSOURCE_XCFW:-$IRONSOURCE_FW}"
          FRAMEWORK_DIR=$(dirname "$FRAMEWORK")
          
          CORONA_INCLUDE="$GITHUB_WORKSPACE/corona_ios_sdk/include"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "Framework: $FRAMEWORK"
          echo "Framework dir: $FRAMEWORK_DIR"
          echo "Corona include: $CORONA_INCLUDE"
          
          ls "$CORONA_INCLUDE" || echo "WARNING: No Corona headers"

          cd ios
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=12.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$FRAMEWORK_DIR" \
            -DNDEBUG -Os \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o

          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          echo "Built: libplugin_ironSource.a"
          ls -lh libplugin_ironSource.a

      # -----------------------------------------------------------------------
      # 4. Package iphone.tgz
      # -----------------------------------------------------------------------
      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone/Frameworks
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua package_iphone/metadata.lua

          # Include IronSource framework
          XCFW=$(find ironsource_framework -name "IronSource.xcframework" 2>/dev/null | head -1)
          FW=$(find ironsource_framework -name "IronSource.framework" 2>/dev/null | head -1)
          FRAMEWORK="${XCFW:-$FW}"
          if [ -n "$FRAMEWORK" ]; then
            FNAME=$(basename "$FRAMEWORK")
            cp -r "$FRAMEWORK" "package_iphone/Frameworks/$FNAME"
            echo "Included: $FNAME"
          fi

          cd package_iphone
          tar czf ../iphone.tgz .
          echo "iphone.tgz contents:"
          tar tzf ../iphone.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
