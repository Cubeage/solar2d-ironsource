name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download IronSource iOS SDK 9.3.0
        run: |
          curl -L "https://raw.githubusercontent.com/ironsource-mobile/iOS-sdk/master/9.3.0/IronSource9.3.0.zip" \
               -o IronSource9.3.0.zip
          mkdir -p ironsource_sdk
          unzip -q IronSource9.3.0.zip -d ironsource_sdk

          XCFW=$(find ironsource_sdk -type d -name "IronSource.xcframework" | head -1)
          echo "XCFramework: $XCFW"

          # Find arm64 device slice (exclude simulator slices)
          ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" \
                     -path "*/ios-arm64/*" ! -path "*simulator*" | head -1)
          if [ -z "$ARM64_FW" ]; then
            ARM64_FW=$(find "$XCFW" -type d -name "IronSource.framework" \
                       ! -path "*simulator*" | head -1)
          fi
          echo "arm64 framework: $ARM64_FW"
          ARM64_DIR=$(dirname "$ARM64_FW")

          echo "IRONSOURCE_ARM64_DIR=$GITHUB_WORKSPACE/$ARM64_DIR" >> "$GITHUB_ENV"
          echo "IRONSOURCE_ARM64_FW=$GITHUB_WORKSPACE/$ARM64_FW"   >> "$GITHUB_ENV"

          # Verify the binary is a static library
          file "$ARM64_FW/IronSource"
          echo "SDK structure:"; find ironsource_sdk -maxdepth 5 | head -30

      - name: Compile iOS static library
        run: |
          CORONA_INCLUDE="$GITHUB_WORKSPACE/ios/corona_sdk"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)

          echo "IRONSOURCE_ARM64_DIR = $IRONSOURCE_ARM64_DIR"
          echo "IRONSOURCE_ARM64_FW  = $IRONSOURCE_ARM64_FW"
          echo "CORONA_INCLUDE       = $CORONA_INCLUDE"
          ls "$CORONA_INCLUDE"

          cd ios
          # Compile plugin source — IronSource headers are imported normally.
          # The framework binary is a static library (ar archive) and will be
          # merged into libplugin_ironSource.a below. No dlopen needed.
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=13.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$IRONSOURCE_ARM64_DIR" \
            -DNDEBUG -Os \
            -Wno-nullability-completeness \
            -Wno-arc-performSelector-leaks \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o

          # Build plugin object into a thin static lib first
          ar rcs libplugin_ironSource_plugin.a plugin_ironSource.o
          ranlib libplugin_ironSource_plugin.a

          # Merge plugin + IronSource static library into one combined .a
          # This embeds all IronSource symbols directly in libplugin_ironSource.a
          # so CoronaBuilder links them into the app binary without any framework embed.
          IRONSOURCE_LIB="$IRONSOURCE_ARM64_FW/IronSource"
          echo "Merging IronSource static lib: $IRONSOURCE_LIB"
          file "$IRONSOURCE_LIB"

          libtool -static \
            libplugin_ironSource_plugin.a \
            "$IRONSOURCE_LIB" \
            -o libplugin_ironSource.a

          echo "Merged static library:"
          ls -lh libplugin_ironSource.a
          echo "iOS static library built successfully"

      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone

          # Only the merged static library + metadata are needed.
          # IronSource is now statically linked — no dynamic framework to embed.
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua              package_iphone/metadata.lua

          cd package_iphone
          tar czf ../iphone.tgz .
          echo "iphone.tgz contents:"
          tar tzf ../iphone.tgz | sort

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
