name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Corona iOS headers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSET_URL=$(gh api repos/coronalabs/corona/releases/latest \
            --jq '[.assets[] | select((.name | startswith("CoronaCards-iOS-")) and (.name | endswith(".zip")) and (.name | contains("MetalANGLE") | not))][0] | .browser_download_url')
          echo "Downloading: $ASSET_URL"
          curl -L "$ASSET_URL" -o CoronaCards-iOS.zip
          unzip -o CoronaCards-iOS.zip -d coronacards_ios
          mkdir -p corona_ios_sdk/include
          HEADER=$(find coronacards_ios -name "CoronaLua.h" | head -1)
          if [ -n "$HEADER" ]; then
            HEADER_DIR=$(dirname "$HEADER")
            cp "$HEADER_DIR"/*.h corona_ios_sdk/include/ 2>/dev/null || true
            echo "Copied Corona headers from: $HEADER_DIR"
            ls corona_ios_sdk/include/
          else
            echo "CoronaLua.h not in zip, falling back to DMG..."
            DMG_URL=$(gh api repos/coronalabs/corona/releases/latest \
              --jq '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
            curl -L "$DMG_URL" -o Solar2D.dmg
            hdiutil attach Solar2D.dmg -mountpoint /Volumes/Solar2D -nobrowse -quiet
            HEADER=$(find /Volumes/Solar2D -name "CoronaLua.h" 2>/dev/null | head -1)
            if [ -n "$HEADER" ]; then
              cp "$(dirname "$HEADER")"/*.h corona_ios_sdk/include/
            else
              echo "ERROR: CoronaLua.h not found"; exit 1
            fi
            hdiutil detach /Volumes/Solar2D -quiet
          fi

      - name: Setup IronSource iOS SDK via CocoaPods
        run: |
          mkdir -p /tmp/ironsource_pod/App.xcodeproj
          python3 - << 'PYEOF'
          import os
          base = '/tmp/ironsource_pod'
          os.makedirs(base + '/App.xcodeproj', exist_ok=True)
          open(base + '/Podfile', 'w').write(
            "platform :ios, '12.0'\nuse_frameworks!\ntarget 'App' do\n  pod 'IronSourceSDK', '~> 9.2'\nend\n"
          )
          pbx = (
            "// !$*UTF8*$!\n{\n"
            "  archiveVersion = 1;\n  classes = {};\n  objectVersion = 56;\n  objects = {\n"
            "    A1 = {isa = PBXProject; buildConfigurationList = A2; compatibilityVersion = \"Xcode 14.0\"; mainGroup = A3; targets = (A4); };\n"
            "    A2 = {isa = XCConfigurationList; buildConfigurations = (A5, A6); defaultConfigurationName = Release; };\n"
            "    A3 = {isa = PBXGroup; children = (); sourceTree = \"<group>\"; };\n"
            "    A4 = {isa = PBXNativeTarget; buildConfigurationList = A7; buildPhases = (); name = App; productType = \"com.apple.product-type.application\"; };\n"
            "    A5 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos;}; name = Debug; };\n"
            "    A6 = {isa = XCBuildConfiguration; buildSettings = {PRODUCT_NAME = App; SDKROOT = iphoneos;}; name = Release; };\n"
            "    A7 = {isa = XCConfigurationList; buildConfigurations = (A5, A6); defaultConfigurationName = Release; };\n"
            "  };\n  rootObject = A1;\n}\n"
          )
          open(base + '/App.xcodeproj/project.pbxproj', 'w').write(pbx)
          print('Written Podfile and xcodeproj')
          PYEOF

          cd /tmp/ironsource_pod
          pod install --repo-update 2>&1 | tail -30 || true

          echo "Searching for IronSource framework..."
          XCFW=$(find /tmp/ironsource_pod -name "IronSource.xcframework" 2>/dev/null | head -1)
          FW=$(find /tmp/ironsource_pod -name "IronSource.framework" 2>/dev/null | head -1)
          FRAMEWORK="${XCFW:-$FW}"

          if [ -n "$FRAMEWORK" ]; then
            mkdir -p "$GITHUB_WORKSPACE/ironsource_framework"
            cp -r "$FRAMEWORK" "$GITHUB_WORKSPACE/ironsource_framework/"
            echo "IRONSOURCE_FW=$GITHUB_WORKSPACE/ironsource_framework/$(basename "$FRAMEWORK")" >> "$GITHUB_ENV"
            echo "Found: $FRAMEWORK"
          else
            echo "ERROR: IronSource framework not found"
            find /tmp/ironsource_pod -maxdepth 5 | head -30
            exit 1
          fi

      - name: Compile iOS static library
        run: |
          FRAMEWORK_DIR=$(dirname "$IRONSOURCE_FW")
          CORONA_INCLUDE="$GITHUB_WORKSPACE/corona_ios_sdk/include"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "IRONSOURCE_FW=$IRONSOURCE_FW"
          echo "SDKROOT=$SDKROOT"
          ls "$CORONA_INCLUDE" 2>/dev/null || echo "WARNING: no Corona headers"

          cd ios
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=12.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$FRAMEWORK_DIR" \
            -DNDEBUG -Os \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o
          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          ls -lh libplugin_ironSource.a

      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone/Frameworks
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua package_iphone/metadata.lua
          if [ -n "$IRONSOURCE_FW" ] && [ -e "$IRONSOURCE_FW" ]; then
            cp -r "$IRONSOURCE_FW" "package_iphone/Frameworks/$(basename "$IRONSOURCE_FW")"
          fi
          cd package_iphone && tar czf ../iphone.tgz . && tar tzf ../iphone.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
