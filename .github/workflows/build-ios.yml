name: Build iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Corona iOS headers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSET_URL=$(gh api repos/coronalabs/corona/releases/latest \
            --jq '[.assets[] | select((.name | startswith("CoronaCards-iOS-")) and (.name | endswith(".zip")) and (.name | contains("MetalANGLE") | not))][0] | .browser_download_url')
          echo "Downloading Corona headers: $ASSET_URL"
          curl -L "$ASSET_URL" -o CoronaCards-iOS.zip
          unzip -o CoronaCards-iOS.zip -d coronacards_ios
          mkdir -p corona_ios_sdk/include
          HEADER=$(find coronacards_ios -name "CoronaLua.h" | head -1)
          if [ -n "$HEADER" ]; then
            cp "$(dirname "$HEADER")"/*.h corona_ios_sdk/include/ 2>/dev/null || true
            echo "Copied Corona headers"
            ls corona_ios_sdk/include/
          else
            echo "Falling back to Solar2D DMG..."
            DMG_URL=$(gh api repos/coronalabs/corona/releases/latest \
              --jq '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
            curl -L "$DMG_URL" -o Solar2D.dmg
            hdiutil attach Solar2D.dmg -mountpoint /Volumes/Solar2D -nobrowse -quiet
            HEADER=$(find /Volumes/Solar2D -name "CoronaLua.h" 2>/dev/null | head -1)
            if [ -n "$HEADER" ]; then
              cp "$(dirname "$HEADER")"/*.h corona_ios_sdk/include/
            else
              echo "ERROR: CoronaLua.h not found"; exit 1
            fi
            hdiutil detach /Volumes/Solar2D -quiet
          fi

      - name: Download IronSource iOS SDK 7.9.0 directly
        run: |
          # Direct download from ironsource-mobile/iOS-sdk GitHub repo
          curl -L "https://raw.githubusercontent.com/ironsource-mobile/iOS-sdk/master/7.9.0/IronSource7.9.0.zip" \
               -o IronSource7.9.0.zip
          mkdir -p ironsource_sdk
          unzip -o IronSource7.9.0.zip -d ironsource_sdk
          echo "IronSource SDK contents:"
          find ironsource_sdk -maxdepth 3 | head -30
          XCFW=$(find ironsource_sdk -name "IronSource.xcframework" -o -name "IronSource.framework" 2>/dev/null | head -1)
          echo "Framework: $XCFW"
          echo "IRONSOURCE_FW=$XCFW" >> "$GITHUB_ENV"

      - name: Compile iOS static library
        run: |
          FRAMEWORK_DIR=$(dirname "$IRONSOURCE_FW")
          CORONA_INCLUDE="$GITHUB_WORKSPACE/corona_ios_sdk/include"
          SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "IRONSOURCE_FW=$IRONSOURCE_FW"
          echo "SDKROOT=$SDKROOT"
          ls "$CORONA_INCLUDE" 2>/dev/null || echo "WARNING: no Corona headers"

          cd ios
          clang \
            -arch arm64 \
            -isysroot "$SDKROOT" \
            -miphoneos-version-min=12.0 \
            -fobjc-arc \
            -std=c++17 \
            -I"$CORONA_INCLUDE" \
            -F"$FRAMEWORK_DIR" \
            -DNDEBUG -Os \
            -c plugin_ironSource.mm \
            -o plugin_ironSource.o
          ar rcs libplugin_ironSource.a plugin_ironSource.o
          ranlib libplugin_ironSource.a
          ls -lh libplugin_ironSource.a

      - name: Package iphone.tgz
        run: |
          mkdir -p package_iphone/Frameworks
          cp ios/libplugin_ironSource.a package_iphone/libplugin_ironSource.a
          cp metadata.lua package_iphone/metadata.lua
          if [ -n "$IRONSOURCE_FW" ] && [ -e "$IRONSOURCE_FW" ]; then
            FNAME=$(basename "$IRONSOURCE_FW")
            cp -r "$IRONSOURCE_FW" "package_iphone/Frameworks/$FNAME"
            echo "Included: $FNAME"
          fi
          cd package_iphone && tar czf ../iphone.tgz . && tar tzf ../iphone.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-plugin
          path: iphone.tgz
