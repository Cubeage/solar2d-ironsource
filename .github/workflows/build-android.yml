name: Build Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Download CoronaCards-Android zip to extract Corona.jar
      - name: Fetch Solar2D Corona.jar
        run: |
          RELEASE_URL="https://api.github.com/repos/coronalabs/corona/releases/latest"
          ASSET_URL=$(curl -s "$RELEASE_URL" | \
            python3 -c "import sys,json; data=json.load(sys.stdin); \
            print(next(a['browser_download_url'] for a in data['assets'] if 'CoronaCards-Android' in a['name']))")
          echo "Downloading: $ASSET_URL"
          curl -L "$ASSET_URL" -o CoronaCards-Android.zip
          unzip -o CoronaCards-Android.zip -d coronacards_android
          mkdir -p android/libs
          # The jar is typically at CoronaCards/Corona.jar or similar
          find coronacards_android -name "*.jar" | while read f; do
            echo "Found jar: $f"
            cp "$f" android/libs/
          done
          ls -la android/libs/

      - name: Make gradlew executable
        run: chmod +x android/gradlew 2>/dev/null || true

      - name: Setup Gradle wrapper (if not present)
        run: |
          if [ ! -f android/gradlew ]; then
            cd android
            gradle wrapper --gradle-version 8.4
          fi

      - name: Build AAR
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace

      - name: Locate AAR
        id: aar
        run: |
          AAR=$(find android -name "*-release.aar" | head -1)
          echo "aar_path=$AAR" >> $GITHUB_OUTPUT
          echo "Found AAR: $AAR"

      - name: Package android.tgz
        run: |
          mkdir -p package_android
          cp "${{ steps.aar.outputs.aar_path }}" package_android/plugin-release.aar
          cp android/corona.gradle package_android/corona.gradle
          cp metadata.lua package_android/metadata.lua
          cd package_android
          tar czf ../android.tgz .
          echo "android.tgz contents:"
          tar tzf ../android.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-plugin
          path: android.tgz
